<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    * { font-family: 'Sarabun', sans-serif !important; }
    body { box-sizing: border-box; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); height: 100vh; overflow-x: hidden; }
    .main-app { background:#f8f9fa; height: 100vh; overflow-y: auto; }
    .login-container { background: rgba(255,255,255,.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,.25); }
    .header-section { background: linear-gradient(135deg,#2563eb,#3b82f6); color: #fff; padding: 1rem 0; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
    .nav-tabs { border-bottom: 2px solid #dee2e6; background: white; padding: .5rem 0; }
    .nav-tabs .nav-link { border:none; color:#6c757d; font-weight:600; font-size:16px; padding:12px 24px; margin:0 4px; border-radius:8px; transition:all .3s }
    .nav-tabs .nav-link:hover { background:#e9ecef; color:#495057; }
    .nav-tabs .nav-link.active { background:#2563eb; color:#fff; border:none; }
    .btn-primary{ background:#2563eb; border-color:#2563eb; font-weight:600; padding:10px 20px; border-radius:8px }
    .btn-primary:hover{ background:#1d4ed8; border-color:#1e40af; transform: translateY(-1px); }
    .btn-success{ background:#2563eb; border-color:#2563eb; font-weight:600; padding:10px 20px; border-radius:8px }
    .btn-info{ background:#0dcaf0; border-color:#0dcaf0; font-weight:600; padding:10px 20px; border-radius:8px }
    .btn-warning{ background:#ffc107; border-color:#ffc107; font-weight:600; padding:10px 20px; border-radius:8px; color:#000 }
    .btn-danger{ background:#dc3545; border-color:#dc3545; font-weight:600; padding:10px 20px; border-radius:8px }
    .card{ border:none; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1); margin-bottom:1rem }
    .card-header{ background: linear-gradient(135deg,#2563eb,#3b82f6); color:#fff; border-radius:12px 12px 0 0 !important; font-weight:600; font-size:18px }
    .form-control,.form-select{ border-radius:8px; border:2px solid #dee2e6; padding:10px 15px; font-size:16px }
    .form-control:focus,.form-select:focus{ border-color:#2563eb; box-shadow:0 0 0 .2rem rgba(37,99,235,.25) }
    .table{ border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.1) }
    .table thead th{ background:#2563eb; color:#fff; border:none; font-weight:600; padding:15px }
    .table tbody td{ padding:12px 15px; vertical-align: middle; }
    .table tbody tr:hover{ background:#f8f9fa }
    .patient-info-card{ background: linear-gradient(135deg,#f8f9fa,#e9ecef); border:2px solid #dee2e6; border-radius:12px; padding:20px; margin:20px 0 }
    .calendar-day{ min-height:110px; border:1px solid #dee2e6; padding:8px; background:#fff; border-radius:4px; margin:2px }
    .calendar-event{ background:#2563eb; color:#fff; padding:2px 6px; border-radius:4px; font-size:11px; margin:1px 0; display:block }
    .loader{ border:4px solid #f3f3f3; border-top:4px solid #2563eb; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .print-only{ display:none }
    @media print{ .no-print{ display:none !important } .print-only{ display:block !important } body{ background:#fff !important } }
    .content-container{ max-height:calc(100vh - 200px); overflow-y:auto; padding:20px }
    .signature-box{ border:2px dashed #dee2e6; border-radius:8px; min-height:50px; display:flex; align-items:center; justify-content:center; color:#6c757d; font-size:14px }
    .report-title{ font-weight:700; font-size:1.1rem }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginScreen" class="d-flex align-items-center justify-content-center" style="height:100vh;">
    <div class="login-container" style="width:100%; max-width:400px; padding:2rem;">
      <div class="text-center mb-4">
        <div class="mx-auto mb-3" style="width:80px; height:80px; background: linear-gradient(135deg,#198754,#20c997); border-radius:50%; display:flex; align-items:center; justify-content:center;">
          <i class="bi bi-capsule text-white" style="font-size:2rem;"></i>
        </div>
        <h1 class="h3 fw-bold text-dark mb-2">ระบบเตรียมยาผลิตเฉพาะราย</h1>
        <p class="text-muted mb-0">โรงพยาบาลนพรัตนราชธานี</p>
      </div>
      <form id="loginForm">
        <div class="mb-3"><label class="form-label fw-semibold">ชื่อผู้ใช้</label><input type="text" id="username" class="form-control" placeholder="admin" required></div>
        <div class="mb-3"><label class="form-label fw-semibold">รหัสผ่าน</label><input type="password" id="password" class="form-control" placeholder="••••••" required></div>
        <button type="submit" id="loginButton" class="btn btn-success w-100 py-2">
          <span id="loginButtonText"><i class="bi bi-box-arrow-in-right me-2"></i>เข้าสู่ระบบ</span>
          <span id="loginButtonLoading" class="d-none">
            <div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Loading...</span></div>กำลังตรวจสอบ...
          </span>
        </button>
      </form>
      <div id="loginError" class="alert alert-danger mt-3 d-none">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง</div>
    </div>
  </div>

  <!-- Main -->
  <div id="mainApp" class="main-app d-none">
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center d-none" style="background:rgba(0,0,0,.5); z-index:9999;">
      <div class="bg-white p-4 rounded shadow-lg d-flex align-items-center"><div class="loader me-3"></div><span class="fw-semibold">กำลังประมวลผล...</span></div>
    </div>

    <header class="header-section no-print">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
          <div><h1 class="h4 fw-bold mb-1">โปรแกรมเตรียมยาผลิตเฉพาะราย</h1><p class="mb-0 opacity-75">โรงพยาบาลนพรัตนราชธานี</p></div>
          <div><button id="logoutBtn" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right me-2"></i>ออกจากระบบ</button></div>
        </div>
      </div>
    </header>

    <nav class="no-print">
      <div class="container-fluid">
        <ul class="nav nav-tabs" id="mainTabs">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#prescriptionTab"><i class="bi bi-file-earmark-medical me-2"></i>ใบสั่งยา</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#medicineTab"><i class="bi bi-capsule me-2"></i>ข้อมูลยา</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reportTab"><i class="bi bi-graph-up me-2"></i>รายงาน</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#editTab"><i class="bi bi-pencil-square me-2"></i>แก้ไขนัด</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#printTab"><i class="bi bi-printer me-2"></i>พิมพ์ใบนัด</a></li>
        </ul>
      </div>
    </nav>

    <div class="content-container">
      <div class="tab-content">
        <!-- ใบสั่งยา -->
        <div class="tab-pane fade show active" id="prescriptionTab">
          <div class="card">
            <div class="card-header">สร้างใบสั่งยาเตรียมผลิต</div>
            <div class="card-body">
              <form id="prescriptionForm">
                <div class="row g-3 mb-4">
                  <div class="col-md-6"><label class="form-label fw-semibold">VN</label><input type="text" id="vnDisplay" class="form-control" readonly style="background:#e9ecef; font-weight:bold; color:#2563eb;"></div>
                </div>
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label fw-semibold">HN</label><input type="text" id="hn" class="form-control" required></div>
                  <div class="col-md-6"><label class="form-label fw-semibold">ชื่อยา</label><select id="medicineSelect" class="form-select" required><option value="">เลือกยา</option></select></div>
                  <div class="col-md-6"><label class="form-label fw-semibold">ชื่อ</label><input type="text" id="firstName" class="form-control" required></div>
                  <div class="col-md-6"><label class="form-label fw-semibold">นามสกุล</label><input type="text" id="lastName" class="form-control" required></div>
                  <div class="col-md-6"><label class="form-label fw-semibold">เบอร์โทรศัพท์</label><input type="tel" id="phone" class="form-control"></div>
                  <div class="col-md-6"><label class="form-label fw-semibold">ปริมาตรที่รับประทานต่อวัน (ซีซี)</label><input type="number" id="dailyDose" class="form-control" step="0.1" required></div>
                  <div class="col-md-6"><label class="form-label fw-semibold">วันรับยาครั้งแรก</label><input type="date" id="firstPickupDate" class="form-control" required></div>
                  <div class="col-md-6"><label class="form-label fw-semibold">วันนัดพบแพทย์</label><input type="date" id="doctorAppointment" class="form-control" required></div>
                </div>
                <div class="text-center mt-4"><button type="submit" class="btn btn-success btn-lg px-5">บันทึกข้อมูลและสร้างใบนัดรับยา</button></div>
              </form>

              <div id="patientPrescriptionCard" class="d-none mt-4">
                <div class="patient-info-card">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h5 class="fw-bold mb-1" id="patientName">ชื่อ-นามสกุล คนไข้</h5>
                      <p class="mb-1 text-muted" id="patientHN">HN: xxxxxxx</p>
                      <p class="mb-0 text-muted" id="patientVN">VN: 1</p>
                    </div>
                    <button id="printPrescription" class="btn btn-info">พิมพ์ใบนัดรับยา</button>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead><tr><th>ชื่อยา</th><th class="text-center">จำนวนขวด</th><th>วันนัดรับยา</th><th class="text-center">วันหมดอายุรอบนี้</th><th class="text-center">ลายเซ็นเภสัชกร</th></tr></thead>
                      <tbody id="prescriptionTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- ข้อมูลยา -->
        <div class="tab-pane fade" id="medicineTab">
          <div class="card mb-3">
            <div class="card-header">เพิ่ม/จัดการข้อมูลยา</div>
            <div class="card-body">
              <form id="medicineForm" class="mb-4">
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label fw-semibold">ชื่อสามัญยา</label><input type="text" id="medicineName" class="form-control" placeholder="เช่น ACETAZOLAMIDE syrup" required></div>
                  <div class="col-md-3"><label class="form-label fw-semibold">ปริมาตร/ขวด (ซีซี)</label><input type="number" id="bottleVolume" class="form-control" placeholder="30" required></div>
                  <div class="col-md-3"><label class="form-label fw-semibold">อายุยา (วัน)</label><input type="number" id="shelfLife" class="form-control" placeholder="7" required></div>
                  <div class="col-md-12">
                    <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="isRTM">
                      <label class="form-check-label" for="isRTM">เป็นยา RTM (มี 2 วันหมดอายุ: อายุ RTM และอายุหลังผสม)</label>
                    </div>
                  </div>
                  <div class="col-md-3 rtm-only d-none"><label class="form-label fw-semibold">RTM Shelf Life (วัน)</label><input type="number" id="rtmShelfLife" class="form-control" placeholder="60"></div>
                  <div class="col-md-3 rtm-only d-none"><label class="form-label fw-semibold">Mixed Shelf Life (วัน)</label><input type="number" id="mixedShelfLife" class="form-control" placeholder="7"></div>
                </div>
                <div class="text-center mt-3"><button type="submit" class="btn btn-success"><i class="bi bi-plus-circle me-2"></i>เพิ่มข้อมูลยา</button></div>
              </form>

              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-header">ยาปกติ</div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-striped mb-0">
                          <thead><tr><th>ชื่อยา</th><th>ปริมาตร/ขวด</th><th>อายุยา</th><th class="text-center">ลบ</th></tr></thead>
                          <tbody id="medicineListNormal"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-header">ยา RTM</div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-striped mb-0">
                          <thead><tr><th>ชื่อยา</th><th>RTM(วัน)</th><th>หลังผสม(วัน)</th><th class="text-center">ลบ</th></tr></thead>
                          <tbody id="medicineListRTM"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- รายงาน + ปฏิทิน -->
        <div class="tab-pane fade" id="reportTab">
          <div class="row g-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header">ปฏิทินการนัดรับยา (ปฏิทินสากลแบบเต็ม)</div>
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <button id="prevMonth" class="btn btn-secondary">เดือนก่อน</button>
                    <h5 id="currentMonth" class="fw-bold mb-0"></h5>
                    <button id="nextMonth" class="btn btn-secondary">เดือนถัดไป</button>
                  </div>
                  <div class="bg-light rounded p-3">
                    <div class="row g-1 mb-2 text-center fw-bold">
                      <div class="col">อา</div><div class="col">จ</div><div class="col">อ</div><div class="col">พ</div><div class="col">พฤ</div><div class="col">ศ</div><div class="col">ส</div>
                    </div>
                    <div id="calendarGrid" class="row g-1"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card">
                <div class="card-header">รายงานการนัดรับยา (ข้อความล้วน)</div>
                <div class="card-body">
                  <div class="row g-3 mb-3">
                    <div class="col-md-4"><label class="form-label fw-semibold">วันที่เริ่มต้น</label><input type="date" id="reportStartDate" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label fw-semibold">วันที่สิ้นสุด</label><input type="date" id="reportEndDate" class="form-control"></div>
                    <div class="col-md-4 d-flex align-items-end gap-2">
                      <button id="generateReport" class="btn btn-success w-100">ค้นหารายงาน</button>
                      <button id="exportReportServer" class="btn btn-primary w-100">Export Excel (Server)</button>
                    </div>
                  </div>
                  <div id="reportResults"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- แก้ไขนัด -->
        <div class="tab-pane fade" id="editTab">
          <div class="card">
            <div class="card-header">แก้ไขวันนัดรับยา</div>
            <div class="card-body">
              <div class="row g-3 mb-4">
                <div class="col-md-8"><label class="form-label fw-semibold">ค้นหาด้วย VN หรือ HN</label><input type="text" id="searchPrescription" class="form-control" placeholder="กรอก VN หรือ HN"></div>
                <div class="col-md-4 d-flex align-items-end"><button id="searchBtn" class="btn btn-warning w-100">ค้นหา</button></div>
              </div>
              <div id="editForm"></div>
            </div>
          </div>
        </div>

        <!-- พิมพ์ใบนัด -->
        <div class="tab-pane fade" id="printTab">
          <div class="card">
            <div class="card-header">พิมพ์ใบนัดรับยา</div>
            <div class="card-body">
              <div class="row g-3 mb-4">
                <div class="col-md-8"><label class="form-label fw-semibold">ค้นหาใบนัดด้วย VN หรือ HN</label><input type="text" id="searchPrintPrescription" class="form-control" placeholder="กรอก VN หรือ HN"></div>
                <div class="col-md-4 d-flex align-items-end"><button id="searchPrintBtn" class="btn btn-primary w-100">ค้นหาใบนัด</button></div>
              </div>
              <div id="printPreview"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="print-only"><div id="printContent"></div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ====================== CONFIG: ใส่ URL Apps Script ของคุณ ====================== */
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzS1cms8GHQW0TQQEVVuOFzQritBL2Xx2Km3NWdFwKHaEDwHtTY2fv15zur2ou9oWv8cQ/exec';

    /* ====================== Global State ====================== */
    let medicines = [];
    let prescriptions = [];
    let currentPrescription = null;
    let vnCounter = 1; // ใช้เฉพาะฝั่ง UI; ถ้าต้องการ VN จากเซิร์ฟเวอร์ให้ย้าย logic ไป Code.gs
    let currentCalendarDate = new Date();

    /* ====================== Utilities ====================== */
    const qs = (sel)=>document.querySelector(sel);
    const qsa = (sel)=>[...document.querySelectorAll(sel)];
    const toISO = (d)=> (new Date(d)).toISOString().split('T')[0];
    const addDays = (d,days)=>{ const x=new Date(d); x.setDate(x.getDate()+days); return x; };
    function thaiDate(iso){ const d=new Date(iso); const m=['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'][d.getMonth()]; return `${d.getDate()} ${m} ${d.getFullYear()+543}`; }
    function thaiDateFull(iso){ const d=new Date(iso); const m=['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'][d.getMonth()]; return `${d.getDate()} ${m} ${d.getFullYear()+543}`; }
    function toast(msg, color='blue'){ const t=document.createElement('div'); t.className='position-fixed top-0 end-0 m-3 px-3 py-2 text-white rounded shadow'; t.style.background=color==='green'?'#16a34a':'#2563eb'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2500); }
    function showLoading(v){ qs('#loadingOverlay').classList.toggle('d-none', !v); }

    /* ====================== API (Apps Script) ====================== */
    async function apiGet(action, params={}){
      const url = new URL(SCRIPT_URL);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, v));
      const res = await fetch(url.toString(), { method:'GET' });
      return res.json();
    }
    async function apiPost(action, payload={}){
      const res = await fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify({ action, ...payload })
      });
      return res.json();
    }

    /* ====================== Login ====================== */
    document.addEventListener('DOMContentLoaded', () => setupLogin());
    function setupLogin(){
      qs('#loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const u = qs('#username').value;
        const p = qs('#password').value;
        const btn = qs('#loginButton');
        const txt = qs('#loginButtonText');
        const ld = qs('#loginButtonLoading');
        btn.disabled=true; txt.classList.add('d-none'); ld.classList.remove('d-none');
        // เดโม่ล็อกอินในหน้า (admin/123) — ถ้าต้องการล็อกอินจริง เชื่อม Code.gs เพิ่มได้
        setTimeout(async ()=>{
          if(u==='admin' && p==='123'){
            qs('#loginScreen').classList.add('d-none');
            qs('#mainApp').classList.remove('d-none');
            await initializeApp();
            toast('เข้าสู่ระบบสำเร็จ','green');
          }else{
            btn.disabled=false; txt.classList.remove('d-none'); ld.classList.add('d-none');
            qs('#loginError').classList.remove('d-none'); setTimeout(()=>qs('#loginError').classList.add('d-none'),3000);
          }
        },600);
      });
    }

    /* ====================== App Init ====================== */
    async function initializeApp(){
      // Events
      qs('#logoutBtn').addEventListener('click', ()=> location.reload());
      qs('#prescriptionForm').addEventListener('submit', onSubmitPrescription);
      qs('#medicineForm').addEventListener('submit', onSubmitMedicine);
      qs('#searchBtn').addEventListener('click', searchPrescription);
      qs('#searchPrintBtn').addEventListener('click', searchForPrint);
      qs('#prevMonth').addEventListener('click', ()=>{ currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); renderCalendar(); });
      qs('#nextMonth').addEventListener('click', ()=>{ currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); renderCalendar(); });
      qs('#isRTM').addEventListener('change', (e)=> qsa('.rtm-only').forEach(el=> el.classList.toggle('d-none', !e.target.checked)) );

      // Defaults
      qs('#vnDisplay').value = vnCounter.toString();
      const today = toISO(new Date());
      qs('#firstPickupDate').value = today;
      qs('#doctorAppointment').value = today;
      qs('#reportStartDate').value = today;
      qs('#reportEndDate').value = today;

      // Load initial data from server
      showLoading(true);
      await loadMedicinesFromServer();
      await refreshAllPrescriptionsFromServer();
      showLoading(false);

      renderCalendar();
    }

    /* ====================== Medicines ====================== */
    async function loadMedicinesFromServer(){
      try{
        const res = await apiGet('listMedicines');
        medicines = res.medicines || [];
        updateMedicineSelect();
        renderMedicineLists();
      }catch(e){ console.error(e); toast('โหลดรายการยาไม่สำเร็จ',''); }
    }
    function updateMedicineSelect(){
      const sel = qs('#medicineSelect');
      sel.innerHTML = '<option value=\"\">เลือกยา</option>' + medicines.map(m=> `<option value=\"${m.id}\">${m.name}</option>`).join('');
    }
    function renderMedicineLists(){
      const normalTbody = qs('#medicineListNormal');
      const rtmTbody = qs('#medicineListRTM');
      normalTbody.innerHTML = medicines.filter(m=>!m.isRTM).map(m=>`
        <tr><td>${m.name}</td><td>${m.bottleVolume} ซีซี</td><td>${m.shelfLife} วัน</td>
        <td class=\"text-center\"><button class=\"btn btn-danger btn-sm\" onclick=\"delMed('${m.id}')\">ลบ</button></td></tr>
      `).join('');
      rtmTbody.innerHTML = medicines.filter(m=>m.isRTM).map(m=>`
        <tr><td>${m.name}</td><td>${m.rtmShelfLife}</td><td>${m.mixedShelfLife}</td>
        <td class=\"text-center\"><button class=\"btn btn-danger btn-sm\" onclick=\"delMed('${m.id}')\">ลบ</button></td></tr>
      `).join('');
    }
    async function onSubmitMedicine(e){
      e.preventDefault();
      const med = {
        name: qs('#medicineName').value.trim(),
        bottleVolume: parseFloat(qs('#bottleVolume').value),
        shelfLife: parseInt(qs('#shelfLife').value),
        isRTM: qs('#isRTM').checked
      };
      if(med.isRTM){
        med.rtmShelfLife = parseInt(qs('#rtmShelfLife').value || '0');
        med.mixedShelfLife = parseInt(qs('#mixedShelfLife').value || '0');
        med.shelfLife = med.mixedShelfLife;
      }
      showLoading(true);
      const res = await apiPost('saveMedicine', { medicine: med });
      showLoading(false);
      if(res.success){ toast('เพิ่ม/อัปเดตยาสำเร็จ','green'); e.target.reset(); qsa('.rtm-only').forEach(el=> el.classList.add('d-none')); await loadMedicinesFromServer(); }
      else toast(res.message || 'บันทึกยาไม่สำเร็จ');
    }
    async function delMed(id){
      if(!confirm('คุณต้องการลบข้อมูลยานี้หรือไม่?')) return;
      showLoading(true);
      const res = await apiPost('deleteMedicine', { id });
      showLoading(false);
      if(res.success){ toast('ลบข้อมูลยาสำเร็จ','green'); await loadMedicinesFromServer(); }
      else toast(res.message || 'ลบไม่สำเร็จ');
    }

    /* ====================== Prescriptions + RTM Logic ====================== */
    async function refreshAllPrescriptionsFromServer(){
      try{
        const res = await apiGet('listPrescriptions');
        prescriptions = (res.prescriptions || []);
      }catch(e){ console.error(e); }
    }

    function buildNormalSchedule(startDateStr, endDateStr, dailyDose, med){
      const start = new Date(startDateStr);
      const end = new Date(endDateStr);
      const totalDays = Math.max(0, Math.ceil((end-start)/(1000*60*60*24)));
      const rounds = Math.max(1, Math.ceil(totalDays / med.shelfLife));
      const bottlesPerRound = Math.ceil((dailyDose * med.shelfLife) / med.bottleVolume);
      const schedule = [];
      for(let i=0;i<rounds;i++){
        const pickup = new Date(start); pickup.setDate(start.getDate() + i*med.shelfLife);
        const expiry = new Date(pickup); expiry.setDate(pickup.getDate() + med.shelfLife);
        schedule.push({ round:i+1, date: toISO(pickup), bottles:bottlesPerRound, expiry: toISO(expiry) });
      }
      return schedule;
    }

    function buildRTMSchedule(startDateStr, endDateStr, med){
      const start = new Date(startDateStr);
      const end = new Date(endDateStr);
      const schedule = [];
      const period2Days = Math.max(0, Math.ceil((end - addDays(start, med.rtmShelfLife))/(1000*60*60*24)));

      // Day 0
      const bottlesDay0 = Math.ceil(med.rtmShelfLife / med.mixedShelfLife);
      schedule.push({ round:1, date: toISO(start), bottles: bottlesDay0, expiry: toISO(addDays(start, med.mixedShelfLife)) });

      // Day RTM expiry
      const rtmExpiryDate = addDays(start, med.rtmShelfLife);
      if(period2Days > 0){
        let remainBottles = Math.ceil(period2Days / med.mixedShelfLife);
        if(period2Days % med.mixedShelfLife <= 1 && remainBottles>1){ remainBottles -= 1; } // match example Zinc -> 4
        schedule.push({ round:2, date: toISO(rtmExpiryDate), bottles: remainBottles, expiry: toISO(addDays(rtmExpiryDate, med.mixedShelfLife)) });
      }
      return schedule;
    }

    async function onSubmitPrescription(e){
      e.preventDefault();
      const medId = qs('#medicineSelect').value;
      const med = medicines.find(m=> m.id===medId);
      if(!med) return alert('กรุณาเลือกยา');

      const data = {
        vn: qs('#vnDisplay').value,
        hn: qs('#hn').value.trim(),
        firstName: qs('#firstName').value.trim(),
        lastName: qs('#lastName').value.trim(),
        phone: qs('#phone').value.trim(),
        medicineId: med.id,
        medicineName: med.name,
        dailyDose: parseFloat(qs('#dailyDose').value),
        firstPickupDate: qs('#firstPickupDate').value,
        doctorAppointment: qs('#doctorAppointment').value
      };

      let schedule = [];
      if(med.isRTM) schedule = buildRTMSchedule(data.firstPickupDate, data.doctorAppointment, med);
      else schedule = buildNormalSchedule(data.firstPickupDate, data.doctorAppointment, data.dailyDose, med);

      currentPrescription = { ...data, medicine: med, schedule, createdDate: toISO(new Date()) };
      // Save to server
      showLoading(true);
      const res = await apiPost('savePrescription', { prescription: {
        vn: currentPrescription.vn,
        hn: currentPrescription.hn,
        firstName: currentPrescription.firstName,
        lastName: currentPrescription.lastName,
        phone: currentPrescription.phone,
        medicineId: currentPrescription.medicine.id,
        medicineName: currentPrescription.medicine.name,
        dailyDose: currentPrescription.dailyDose,
        firstPickupDate: currentPrescription.firstPickupDate,
        doctorAppointment: currentPrescription.doctorAppointment,
        createdDate: currentPrescription.createdDate,
        schedule: currentPrescription.schedule
      }});
      await refreshAllPrescriptionsFromServer();
      showLoading(false);

      if(!res.success){ toast(res.message || 'บันทึกใบสั่งยาไม่สำเร็จ'); return; }

      renderPatientCard();
      vnCounter++; qs('#vnDisplay').value = vnCounter.toString();
      renderCalendar();
      toast('บันทึกใบสั่งยาสำเร็จ','green');
    }

    function renderPatientCard(){
      qs('#patientPrescriptionCard').classList.remove('d-none');
      qs('#patientName').textContent = `${currentPrescription.firstName} ${currentPrescription.lastName}`;
      qs('#patientHN').textContent = `HN: ${currentPrescription.hn}`;
      qs('#patientVN').textContent = `VN: ${currentPrescription.vn}`;
      qs('#prescriptionTableBody').innerHTML = currentPrescription.schedule.map(item => `
        <tr>
          <td class="fw-semibold">${currentPrescription.medicine.name}</td>
          <td class="text-center fw-bold text-success fs-5">${item.bottles}</td>
          <td class="fw-semibold">${thaiDateFull(item.date)}</td>
          <td class="text-center">${thaiDateFull(item.expiry)}</td>
          <td class="text-center"><div class="signature-box">ลายเซ็นเภสัชกร</div></td>
        </tr>
      `).join('');
      qs('#printPrescription').onclick = printPrescription;
    }

    /* ====================== Calendar ====================== */
    function renderCalendar(){
      const y = currentCalendarDate.getFullYear();
      const m = currentCalendarDate.getMonth();
      const thaiMonths = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
      qs('#currentMonth').textContent = `${thaiMonths[m]} ${y+543}`;

      const first = new Date(y, m, 1);
      const start = new Date(first); start.setDate(first.getDate() - first.getDay()); // Sunday start
      const grid = qs('#calendarGrid'); grid.innerHTML = '';

      for(let week=0; week<6; week++){
        const row = document.createElement('div'); row.className='col-12';
        const inner = document.createElement('div'); inner.className='row g-1';
        for(let day=0; day<7; day++){
          const d = new Date(start); d.setDate(start.getDate() + week*7 + day);
          const col = document.createElement('div'); col.className='col';
          const cell = document.createElement('div'); cell.className='calendar-day';
          if(d.getMonth() !== m){ cell.classList.add('text-muted','bg-light'); }
          const iso = toISO(d);
          const evs = eventsByDate(iso);
          cell.innerHTML = `<div class="fw-bold mb-1">${d.getDate()}</div><div>${evs.map(ev=> `<span class="calendar-event" title="${ev.patient} - ${ev.med}">${ev.patient.split(' ')[0]} (${ev.bottles}ขวด)</span>`).join('')}</div>`;
          col.appendChild(cell); inner.appendChild(col);
        }
        row.appendChild(inner); grid.appendChild(row);
      }
    }
    function eventsByDate(isoDate){
      const arr = [];
      prescriptions.forEach(p=>{
        (p.schedule||[]).forEach(s=>{
          if(s.date === isoDate){
            arr.push({ patient: `${p.firstName} ${p.lastName}`, med: p.medicineName || '', bottles: s.bottles, hn: p.hn, vn: p.vn });
          }
        });
      });
      return arr;
    }

    /* ====================== Reports ====================== */
    document.addEventListener('click', async (e)=>{
      if(e.target.id==='generateReport'){ await generateReport(); }
      if(e.target.id==='exportReport'){ exportToExcelXLSX(); }
      if(e.target.id==='exportReportServer'){ await exportReportServer(); }
    });

    async function generateReport(){
      const s = qs('#reportStartDate').value;
      const e = qs('#reportEndDate').value;
      if(!s || !e) return alert('กรุณาเลือกช่วงวันที่');
      showLoading(true);
      const rep = await apiGet('getReport', { startDate: s, endDate: e });
      showLoading(false);

      const rows = (rep.rows || []).map(r => [r.date, r.vn, r.hn, r.name, r.medicine, r.bottles, r.phone]);
      const container = qs('#reportResults');
      if(rows.length===0){
        container.innerHTML = `<div class="text-center py-4"><div class="report-title">ไม่พบข้อมูลในช่วงวันที่ที่เลือก</div></div>`;
        return;
      }
      const html = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="report-title">รายงานการนัดรับยา (${thaiDate(s)} - ${thaiDate(e)}) — จำนวน ${rows.length} รายการ</div>
          <button id="exportReport" class="btn btn-success btn-sm">Export Excel (หน้าเว็บ)</button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0" id="reportTable">
            <thead><tr><th>วันที่นัด</th><th>VN</th><th>HN</th><th>ชื่อ-นามสกุล</th><th>ยา</th><th>จำนวนขวด</th><th>เบอร์โทร</th></tr></thead>
            <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>
          </table>
        </div>`;
      container.innerHTML = html;
    }
    function exportToExcelXLSX(){
      const table = qs('#reportTable');
      if(!table) return alert('ไม่พบตารางรายงาน');
      const wb = XLSX.utils.table_to_book(table, {sheet:'รายงาน'});
      const fname = `รายงานการนัดรับยา_${toISO(new Date())}.xlsx`;
      XLSX.writeFile(wb, fname);
      toast('ส่งออกไฟล์ Excel เรียบร้อย','green');
    }
    async function exportReportServer(){
      const s = qs('#reportStartDate').value;
      const e = qs('#reportEndDate').value;
      if(!s || !e) return alert('กรุณาเลือกช่วงวันที่');
      showLoading(true);
      const res = await apiGet('exportReportXlsx', { startDate: s, endDate: e });
      showLoading(false);
      if(res.success && res.url){ window.open(res.url, '_blank'); }
      else toast(res.message || 'ไม่สามารถส่งออกด้วยเซิร์ฟเวอร์');
    }

    /* ====================== Edit/Search & Print ====================== */
    async function searchPrescription(){
      const term = qs('#searchPrescription').value.trim();
      if(!term) return alert('กรุณากรอก VN หรือ HN');
      const res = await apiGet('listPrescriptions', { q: term });
      const p = (res.prescriptions||[])[0];
      if(!p) return alert('ไม่พบข้อมูลใบสั่งยา');
      renderEditForm(p);
    }
    function renderEditForm(p){
      const box = qs('#editForm');
      box.innerHTML = `
        <div class="card mb-3">
          <div class="card-header">ข้อมูลปัจจุบัน</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3"><strong>VN:</strong> ${p.vn}</div>
              <div class="col-md-3"><strong>HN:</strong> ${p.hn}</div>
              <div class="col-md-3"><strong>ชื่อ:</strong> ${p.firstName} ${p.lastName}</div>
              <div class="col-md-3"><strong>ยา:</strong> ${p.medicineName||''}</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">แก้ไขวันนัดและจำนวนขวด</div>
          <div class="card-body">
            ${(p.schedule||[]).map((it,idx)=>`
              <div class="card mb-3"><div class="card-body">
                <div class="row g-3 align-items-center">
                  <div class="col-md-2"><label class="form-label fw-semibold">รอบที่ ${it.round}</label></div>
                  <div class="col-md-3"><label class="form-label">วันที่รับยา</label><input type="date" id="editDate_${idx}" value="${it.date}" class="form-control"></div>
                  <div class="col-md-3"><label class="form-label">จำนวนขวด</label><input type="number" id="editBottles_${idx}" value="${it.bottles}" min="1" class="form-control"></div>
                  <div class="col-md-2"><button class="btn btn-success w-100" onclick="updateSchedule('${p.vn}', ${idx})">อัพเดท</button></div>
                  <div class="col-md-2"><button class="btn btn-danger w-100" onclick="deleteSchedule('${p.vn}', ${idx})">ลบ</button></div>
                </div>
              </div></div>
            `).join('')}
            <div class="text-center mt-2"><button class="btn btn-info" onclick="addNewSchedule('${p.vn}')">เพิ่มรอบใหม่</button></div>
          </div>
        </div>`;
      // เก็บล่าสุดใน memory เพื่อพิมพ์ปฏิทิน
      const idx = prescriptions.findIndex(x=> x.vn===p.vn);
      if(idx>=0) prescriptions[idx]=p; else prescriptions.push(p);
      renderCalendar();
    }
    async function updateSchedule(vn, idx){
      const p = prescriptions.find(x=> x.vn===vn);
      if(!p) return;
      const newDate = qs(`#editDate_${idx}`).value;
      const newB = parseInt(qs(`#editBottles_${idx}`).value);
      if(!newDate || !newB) return alert('กรอกข้อมูลให้ครบ');
      p.schedule[idx].date = newDate;
      p.schedule[idx].bottles = newB;
      showLoading(true);
      const res = await apiPost('updateSchedule', { vn, schedule: p.schedule });
      showLoading(false);
      if(res.success){ toast('อัปเดตข้อมูลเรียบร้อยแล้ว','green'); renderEditForm(p); }
      else toast(res.message || 'อัปเดตไม่สำเร็จ');
    }
    async function deleteSchedule(vn, idx){
      if(!confirm('คุณต้องการลบรอบนี้หรือไม่?')) return;
      const p = prescriptions.find(x=> x.vn===vn); if(!p) return;
      p.schedule.splice(idx,1);
      p.schedule.forEach((it,i)=> it.round=i+1);
      showLoading(true);
      const res = await apiPost('updateSchedule', { vn, schedule: p.schedule });
      showLoading(false);
      if(res.success){ toast('ลบเรียบร้อยแล้ว','green'); renderEditForm(p); }
      else toast(res.message || 'ลบไม่สำเร็จ');
    }
    async function addNewSchedule(vn){
      const p = prescriptions.find(x=> x.vn===vn); if(!p) return;
      const last = p.schedule[p.schedule.length-1];
      const d = new Date(last.date); d.setDate(d.getDate() + 7); // ค่าเริ่มต้น +7 วัน (ปรับตามยาจริงได้)
      p.schedule.push({ round:p.schedule.length+1, date:toISO(d), bottles:last.bottles, expiry:toISO(addDays(d,7)) });
      showLoading(true);
      const res = await apiPost('updateSchedule', { vn, schedule: p.schedule });
      showLoading(false);
      if(res.success){ toast('เพิ่มรอบใหม่เรียบร้อยแล้ว','green'); renderEditForm(p); }
      else toast(res.message || 'เพิ่มรอบไม่สำเร็จ');
    }

    async function searchForPrint(){
      const term = qs('#searchPrintPrescription').value.trim();
      if(!term) return alert('กรุณากรอก VN หรือ HN');
      const res = await apiGet('listPrescriptions', { q: term });
      const p = (res.prescriptions||[])[0];
      if(!p) return alert('ไม่พบข้อมูล');
      qs('#printPreview').innerHTML = `
        <div class="border rounded p-3">
          <div class="d-flex justify-content-between">
            <div><div><strong>VN:</strong> ${p.vn}</div><div><strong>HN:</strong> ${p.hn}</div><div><strong>ผู้ป่วย:</strong> ${p.firstName} ${p.lastName}</div></div>
            <div><button class="btn btn-info" onclick="(function(){ currentPrescription = ${JSON.stringify({})}; currentPrescription = ${JSON.stringify(p)}; printPrescription(); })()">พิมพ์ใบนัด</button></div>
          </div>
        </div>`;
    }

    /* ====================== Printing ====================== */
function printPrescription(){
  const p = currentPrescription;
  const html = `
    <div style="padding:40px; font-family:'Sarabun', serif; max-width:210mm; margin:0 auto; color:#000000;">
      <div style="text-align:center; margin-bottom:40px; border-bottom:3px solid #000000; padding-bottom:20px; color:#000000;">
        <h1 style="font-size:26px; font-weight:bold; margin-bottom:10px; color:#000000;">ใบค้างรับยาผลิตเฉพาะราย(กรุณารับยาหลัง 14.00 น.)</h1>
        <h2 style="font-size:20px; font-weight:bold; color:#000000; margin-bottom:5px;">งานจ่ายยาผู้ป่วยนอก โรงพยาบาลนพรัตนราชธานี</h2>
      </div>
      <div style="margin-bottom:30px; background:#FFFFFF; padding:20px; border-radius:12px; border-left:5px solid #FFFFFF; color:#000000;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap: 10px; color:#000000;">
          <div><p style="color:#000000;"><strong>VN:</strong> ${p.vn}</p><p style="color:#000000;"><strong>HN:</strong> ${p.hn}</p><p style="color:#000000;"><strong>ชื่อ-นามสกุล:</strong> ${p.firstName} ${p.lastName}</p></div>
          <div><p style="color:#000000;"><strong>ยา:</strong> ${p.medicineName||p.medicine?.name||''}</p><p style="color:#000000;"><strong>เบอร์โทร:</strong> ${p.phone || '-'}</p><p style="color:#000000;"><strong>วันที่:</strong> ${thaiDateFull(p.createdDate||toISO(new Date()))}</p></div>
        </div>
      </div>
      <table style="width:100%; border-collapse:collapse; margin-bottom: 30px; color:#000000;">
        <thead>
          <tr>
            <th style="padding:10px; text-align:left; border-bottom:2px solid #000000; color:#000000;">ชื่อยา</th>
            <th style="padding:10px; text-align:center; border-bottom:2px solid #000000; color:#000000;">จำนวนขวด</th>
            <th style="padding:10px; text-align:left; border-bottom:2px solid #000000; color:#000000;">วันนัดรับยา</th>
            <th style="padding:10px; text-align:center; border-bottom:2px solid #000000; color:#000000;">ลายเซ็นเภสัชกร</th>
          </tr>
        </thead>
        <tbody>
          ${(p.schedule||[]).map((it)=>`
            <tr>
              <td style="padding:10px; color:#000000;">${p.medicineName||p.medicine?.name||''}</td>
              <td style="padding:10px; text-align:center; font-weight:700; color:#000000;">${it.bottles}</td>
              <td style="padding:10px; color:#000000;">${thaiDateFull(it.date)}</td>
              <td style="padding:10px; text-align:center; color:#000000;">
                <div style="border:2px dashed #000000; border-radius:8px; height:60px; display:flex; align-items:center; justify-content:center; color:#000000;">ลายเซ็นเภสัชกร</div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>`;

  /* --- พิมพ์ผ่าน iframe ซ่อน (ไม่เปิด about:blank) --- */
  const iframe = document.createElement('iframe');
  iframe.style.position = 'fixed';
  iframe.style.right = '0';
  iframe.style.bottom = '0';
  iframe.style.width = '0';
  iframe.style.height = '0';
  iframe.style.border = '0';
  document.body.appendChild(iframe);

  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open();
  doc.write(`<!doctype html><html><head><title></title></head><body style="color:#000000;">${html}</body></html>`);
  doc.close();

  const doPrint = () => {
    try {
      iframe.contentDocument.title = ''; // ช่วยลดการแสดงเลขหน้าที่มาจาก title
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
    } finally {
      setTimeout(()=> document.body.removeChild(iframe), 500);
    }
  };
  if (iframe.contentWindow.document.readyState === 'complete') doPrint();
  else iframe.onload = doPrint;
}

  </script>
</body>
</html>

