<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    * { font-family: 'Sarabun', sans-serif !important; }
    body { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); height: 100vh; overflow-x: hidden; }
    .main-app { background:#f8f9fa; height: 100vh; overflow-y: auto; }
    .login-container { background: rgba(255,255,255,.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,.25); }
    .header-section { background: linear-gradient(135deg,#2563eb,#3b82f6); color: #fff; padding: 1rem 0; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
    .nav-tabs .nav-link.active { background:#2563eb; color:#fff; border:none; }
    .card{ border:none; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1); margin-bottom:1rem }
    .card-header{ background: linear-gradient(135deg,#2563eb,#3b82f6); color:#fff; border-radius:12px 12px 0 0 !important; font-weight:600; font-size:18px }
    .loader{ border:4px solid #f3f3f3; border-top:4px solid #2563eb; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .print-only{ display:none }
    
    /* แก้ไขการพิมพ์: ซ่อน Header/Footer ของ Browser */
    @media print { 
      .no-print{ display:none !important } 
      .print-only{ display:block !important } 
      body{ background:#fff !important }
      @page { margin: 0; size: auto; }
    }
  </style>
</head>
<body>
  <div id="loginScreen" class="d-flex align-items-center justify-content-center" style="height:100vh;">
    <div class="login-container" style="width:100%; max-width:400px; padding:2rem;">
      <div class="text-center mb-4">
        <div class="mx-auto mb-3" style="width:80px; height:80px; background: linear-gradient(135deg,#198754,#20c997); border-radius:50%; display:flex; align-items:center; justify-content:center;">
          <i class="bi bi-capsule text-white" style="font-size:2rem;"></i>
        </div>
        <h1 class="h3 fw-bold text-dark mb-2">ระบบเตรียมยาผลิตเฉพาะราย</h1>
      </div>
      <form id="loginForm">
        <div class="mb-3"><label class="form-label">ชื่อผู้ใช้</label><input type="text" id="username" class="form-control" placeholder="admin"></div>
        <div class="mb-3"><label class="form-label">รหัสผ่าน</label><input type="password" id="password" class="form-control" placeholder="••••••"></div>
        <button type="submit" id="loginButton" class="btn btn-success w-100 py-2">เข้าสู่ระบบ</button>
      </form>
    </div>
  </div>

  <div id="mainApp" class="main-app d-none">
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center d-none" style="background:rgba(0,0,0,.5); z-index:9999;">
      <div class="bg-white p-4 rounded shadow-lg d-flex align-items-center"><div class="loader me-3"></div><span class="fw-semibold">กำลังประมวลผล...</span></div>
    </div>

    <header class="header-section no-print">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
          <div><h1 class="h4 fw-bold mb-1">โปรแกรมเตรียมยาผลิตเฉพาะราย</h1><p class="mb-0 opacity-75">โรงพยาบาลนพรัตนราชธานี</p></div>
          <div><button id="logoutBtn" class="btn btn-outline-danger btn-sm text-white border-white">ออกจากระบบ</button></div>
        </div>
      </div>
    </header>

    <nav class="no-print container-fluid mt-2">
      <ul class="nav nav-tabs" id="mainTabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#prescriptionTab">ใบสั่งยา</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#medicineTab">ข้อมูลยา</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#productionTab">ส่งเตรียมยาผลิต</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reportTab">รายงาน</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#editTab">แก้ไขนัด</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#printTab">พิมพ์ใบนัด</a></li>
      </ul>
    </nav>

    <div class="container-fluid py-3 content-container">
      <div class="tab-content">
        <div class="tab-pane fade show active" id="prescriptionTab">
          <div class="card">
            <div class="card-header">สร้างใบสั่งยาเตรียมผลิต</div>
            <div class="card-body">
              <form id="prescriptionForm">
                <div class="row g-3 mb-4">
                  <div class="col-md-2"><label class="form-label fw-bold">VN (Auto)</label><input type="text" id="vnDisplay" class="form-control" readonly style="background:#e9ecef; font-weight:bold; color:#2563eb;"></div>
                  <div class="col-md-10 d-flex align-items-end"><small class="text-muted">*ระบบจะรัน VN ต่อจากเลขล่าสุดในฐานข้อมูล</small></div>
                </div>
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label">HN</label><input type="text" id="hn" class="form-control" required></div>
                  <div class="col-md-6"><label class="form-label">ชื่อยา</label><select id="medicineSelect" class="form-select" required><option value="">เลือกยา</option></select></div>
                  <div class="col-md-6"><label class="form-label">ชื่อ</label><input type="text" id="firstName" class="form-control" required></div>
                  <div class="col-md-6"><label class="form-label">นามสกุล</label><input type="text" id="lastName" class="form-control" required></div>
                  <div class="col-md-6"><label class="form-label">เบอร์โทรศัพท์</label><input type="tel" id="phone" class="form-control"></div>
                  <div class="col-md-6"><label class="form-label">ปริมาตรรับประทาน (ซีซี/วัน)</label><input type="number" id="dailyDose" class="form-control" step="0.1" required></div>
                  <div class="col-md-6"><label class="form-label">วันรับยาครั้งแรก</label><input type="date" id="firstPickupDate" class="form-control" required></div>
                  <div class="col-md-6"><label class="form-label">วันนัดพบแพทย์</label><input type="date" id="doctorAppointment" class="form-control" required></div>
                </div>
                <div class="text-center mt-4"><button type="submit" class="btn btn-success px-5">บันทึกและสร้างใบนัด</button></div>
              </form>
              <div id="patientPrescriptionCard" class="d-none mt-4">
                <div class="alert alert-info border-info">
                   <div class="d-flex justify-content-between align-items-center">
                      <div><h5 id="patientName" class="fw-bold mb-0"></h5><small id="patientMeta"></small></div>
                      <button id="printPrescriptionBtn" class="btn btn-primary"><i class="bi bi-printer me-2"></i>พิมพ์ใบนัด</button>
                   </div>
                   <table class="table mt-3 bg-white rounded">
                     <thead><tr><th>รอบที่</th><th>วันที่รับ</th><th>จำนวนขวด</th><th>วันหมดอายุ</th></tr></thead>
                     <tbody id="prescriptionTableBody"></tbody>
                   </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="medicineTab">
          <div class="card mb-3">
            <div class="card-header">จัดการข้อมูลยา</div>
            <div class="card-body">
              <form id="medicineForm" class="mb-4">
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label">ชื่อสามัญยา</label><input type="text" id="medicineName" class="form-control" required></div>
                  <div class="col-md-3"><label class="form-label">ปริมาตร/ขวด (cc)</label><input type="number" id="bottleVolume" class="form-control" required></div>
                  <div class="col-md-3"><label class="form-label">อายุยา (วัน)</label><input type="number" id="shelfLife" class="form-control" required></div>
                  <div class="col-md-3"><label class="form-label text-primary fw-bold">จำนวนเม็ดที่ใช้/ขวด</label><input type="number" id="tabletsPerBottle" class="form-control" placeholder="0" required></div>
                  <div class="col-md-12"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="isRTM"><label class="form-check-label" for="isRTM">เป็นยา RTM</label></div></div>
                  <div class="col-md-3 rtm-only d-none"><label class="form-label">RTM Shelf Life</label><input type="number" id="rtmShelfLife" class="form-control"></div>
                  <div class="col-md-3 rtm-only d-none"><label class="form-label">Mixed Shelf Life</label><input type="number" id="mixedShelfLife" class="form-control"></div>
                </div>
                <div class="mt-3"><button type="submit" class="btn btn-primary">บันทึกข้อมูลยา</button></div>
              </form>
              <div class="table-responsive">
                <table class="table table-bordered">
                   <thead class="table-light"><tr><th>ชื่อยา</th><th>ขนาด(cc)</th><th>ใช้เม็ด(tab)</th><th>ประเภท</th><th>ลบ</th></tr></thead>
                   <tbody id="medicineListBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="productionTab">
          <div class="card">
             <div class="card-header">เตรียมยาผลิต (ฝ่ายผลิต)</div>
             <div class="card-body">
                <div class="row g-3 align-items-end mb-4">
                   <div class="col-md-4"><label class="form-label">เลือกวันที่ผลิต</label><input type="date" id="productionDate" class="form-control"></div>
                   <div class="col-md-4"><button id="btnSearchProduction" class="btn btn-primary w-100">ดูรายการผลิต</button></div>
                </div>
                <div id="productionResult" class="d-none">
                   <div class="d-flex justify-content-between mb-2">
                      <h5 class="fw-bold text-success">รายการที่ต้องเตรียม</h5>
                      <button id="btnPrintProduction" class="btn btn-warning"><i class="bi bi-printer me-2"></i>พิมพ์ใบเบิกยา (A5)</button>
                   </div>
                   <table class="table table-bordered table-striped" id="productionTable">
                      <thead><tr><th>ลำดับ</th><th>รายการยาเตรียม</th><th>จำนวนขวด</th><th>จำนวนเม็ดยาที่ต้องใช้</th><th>หมายเหตุ</th></tr></thead>
                      <tbody></tbody>
                   </table>
                </div>
             </div>
          </div>
        </div>

        <div class="tab-pane fade" id="reportTab">
           <div class="card mb-3"><div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                 <button id="prevMonth" class="btn btn-secondary btn-sm">เดือนก่อน</button>
                 <h5 id="currentMonth" class="mb-0 fw-bold"></h5>
                 <button id="nextMonth" class="btn btn-secondary btn-sm">เดือนถัดไป</button>
              </div>
              <div id="calendarGrid" class="row g-1"></div>
           </div></div>
        </div>

        <div class="tab-pane fade" id="editTab">
           <div class="card"><div class="card-body">
              <div class="input-group mb-3">
                 <input type="text" id="searchPrescription" class="form-control" placeholder="VN หรือ HN">
                 <button id="searchBtn" class="btn btn-warning">ค้นหา</button>
              </div>
              <div id="editForm"></div>
           </div></div>
        </div>

        <div class="tab-pane fade" id="printTab">
           <div class="card"><div class="card-body">
              <div class="input-group mb-3">
                 <input type="text" id="searchPrintInput" class="form-control" placeholder="VN หรือ HN">
                 <button id="searchPrintBtn" class="btn btn-primary">ค้นหา</button>
              </div>
              <div id="printPreview"></div>
           </div></div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ====================== CONFIG ====================== */
    // อย่าลืมอัปเดต URL นี้หลังจาก Deploy ใหม่นะครับ!
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAhrhIOFmO9xiq6IVgxI-Q0ZbGBRL5OZvYCeGEf86D8HKr2MG6B54weQJ4igQIrzVR4g/exec';

    /* ====================== GLOBAL STATE ====================== */
    let medicines = [];
    let prescriptions = [];
    let currentPrescription = null;
    let foundPrescriptionForPrint = null;
    let currentCalendarDate = new Date();

    /* ====================== UTILS ====================== */
    const qs = (s)=>document.querySelector(s);
    const qsa = (s)=>[...document.querySelectorAll(s)];
    // ป้องกัน Timezone เพี้ยน: จัดการวันที่แบบ String ล้วน
    const getDateString = (d) => {
       if(!d) return '';
       const date = (d instanceof Date) ? d : new Date(d);
       const y = date.getFullYear();
       const m = String(date.getMonth()+1).padStart(2,'0');
       const day = String(date.getDate()).padStart(2,'0');
       return `${y}-${m}-${day}`;
    };
    const parseDate = (s) => {
       if(!s) return new Date();
       const [y,m,d] = s.split('-').map(Number);
       return new Date(y, m-1, d, 0, 0, 0); 
    };
    function thaiDate(iso){ 
       const d=parseDate(iso); 
       const m=['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'][d.getMonth()]; 
       return `${d.getDate()} ${m} ${d.getFullYear()+543}`; 
    }
    function showLoading(v){ qs('#loadingOverlay').classList.toggle('d-none', !v); }
    function toast(msg, c='blue'){ 
       const d=document.createElement('div'); 
       d.className=`position-fixed top-0 end-0 m-3 px-3 py-2 text-white rounded shadow bg-${c=='green'?'success':(c=='red'?'danger':'primary')}`;
       d.textContent=msg; document.body.append(d); setTimeout(()=>d.remove(),3000); 
    }

    /* ====================== API ====================== */
    async function apiGet(act, p={}){
       const u = new URL(SCRIPT_URL); u.searchParams.set('action', act);
       Object.keys(p).forEach(k=>u.searchParams.set(k,p[k]));
       return fetch(u).then(r=>r.json());
    }
    async function apiPost(act, data){
       return fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:act, ...data})}).then(r=>r.json());
    }

    /* ====================== INIT ====================== */
    document.addEventListener('DOMContentLoaded', ()=>{
       qs('#loginForm').addEventListener('submit', async(e)=>{
          e.preventDefault();
          if(qs('#username').value==='admin' && qs('#password').value==='123'){
             qs('#loginScreen').classList.add('d-none'); qs('#mainApp').classList.remove('d-none');
             await initApp();
          } else toast('รหัสผ่านผิด','red');
       });
    });

    async function initApp(){
       showLoading(true);
       await Promise.all([loadMedicines(), loadPrescriptions(), fetchNextVN()]);
       
       qs('#medicineForm').addEventListener('submit', saveMedicine);
       qs('#prescriptionForm').addEventListener('submit', savePrescription);
       qs('#printPrescriptionBtn').addEventListener('click', ()=> printPrescription(currentPrescription));
       qs('#searchBtn').addEventListener('click', searchForEdit);
       qs('#searchPrintBtn').addEventListener('click', searchForPrintTab);
       qs('#btnSearchProduction').addEventListener('click', searchProduction);
       qs('#btnPrintProduction').addEventListener('click', printProductionA5);
       qs('#isRTM').addEventListener('change', (e)=>qsa('.rtm-only').forEach(x=>x.classList.toggle('d-none',!e.target.checked)));
       
       qs('#vnDisplay').value = 'กำลังโหลด...';
       qs('#productionDate').value = getDateString(new Date());
       qs('#firstPickupDate').value = getDateString(new Date());
       qs('#doctorAppointment').value = getDateString(new Date());
       
       renderCalendar();
       showLoading(false);
    }

    async function fetchNextVN(){
       try {
         const res = await apiGet('getNextVN');
         qs('#vnDisplay').value = res.vn || '1';
       } catch(e){ console.error(e); }
    }

    async function loadMedicines(){
       const res = await apiGet('listMedicines');
       medicines = res.medicines || [];
       const sel = qs('#medicineSelect');
       sel.innerHTML = '<option value="">เลือกยา</option>' + medicines.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
       
       const tb = qs('#medicineListBody');
       tb.innerHTML = medicines.map(m => `
         <tr>
           <td>${m.name}</td><td>${m.bottleVolume}</td><td>${m.tabletsPerBottle}</td>
           <td>${m.isRTM?'RTM':'ทั่วไป'}</td>
           <td><button class="btn btn-sm btn-danger" onclick="deleteMedicine('${m.id}')">ลบ</button></td>
         </tr>
       `).join('');
    }

    async function loadPrescriptions(){
       const res = await apiGet('listPrescriptions');
       prescriptions = res.prescriptions || [];
    }

    /* ====================== LOGIC: CALCULATE ====================== */
    function buildSchedule(startStr, docDateStr, dose, med){
       const start = parseDate(startStr);
       const end = parseDate(docDateStr);
       
       // จำนวนวันทั้งหมด (อย่างน้อย 1 วัน)
       const diffTime = Math.abs(end - start);
       const totalDays = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24))); 
       
       let totalVolumeNeeded = totalDays * dose; // ปริมาตรยาทั้งหมดที่ต้องใช้ตลอดคอร์ส
       
       const schedule = [];
       let currentD = new Date(start);
       let round = 1;

       const period = med.isRTM ? med.mixedShelfLife : med.shelfLife;
       
       while(totalVolumeNeeded > 0.1){ // Loop จนกว่ายาจะหมด (ใช้ 0.1 เผื่อทศนิยม)
          let daysThisRound = period;
          
          let volThisRound = daysThisRound * dose;
          
          // ตรวจสอบรอบสุดท้าย: ถ้าเหลือยา น้อยกว่าที่ต้องใช้ 1 รอบปกติ -> ใช้เท่าที่เหลือ
          if(totalVolumeNeeded < volThisRound){
             volThisRound = totalVolumeNeeded;
          }
          
          const bottles = Math.ceil(volThisRound / med.bottleVolume);
          const expiry = new Date(currentD); 
          expiry.setDate(expiry.getDate() + daysThisRound);

          schedule.push({
             round: round++,
             date: getDateString(currentD),
             bottles: bottles,
             expiry: getDateString(expiry)
          });
          
          totalVolumeNeeded -= volThisRound;
          currentD = new Date(expiry);
          
          if(round > 50) break; // Safety
       }
       return schedule;
    }

    /* ====================== ACTIONS ====================== */
    async function saveMedicine(e){
       e.preventDefault();
       const m = {
          name: qs('#medicineName').value,
          bottleVolume: qs('#bottleVolume').value,
          shelfLife: qs('#shelfLife').value,
          tabletsPerBottle: qs('#tabletsPerBottle').value,
          isRTM: qs('#isRTM').checked,
          rtmShelfLife: qs('#rtmShelfLife').value,
          mixedShelfLife: qs('#mixedShelfLife').value
       };
       showLoading(true);
       await apiPost('saveMedicine', {medicine:m});
       await loadMedicines();
       qs('#medicineForm').reset();
       showLoading(false);
    }
    async function deleteMedicine(id){
       if(!confirm('ยืนยันลบ?')) return;
       await apiPost('deleteMedicine', {id});
       await loadMedicines();
    }

    async function savePrescription(e){
       e.preventDefault();
       const medId = qs('#medicineSelect').value;
       const med = medicines.find(x=>x.id===medId);
       if(!med) return alert('เลือกยา');
       
       const p = {
          vn: qs('#vnDisplay').value,
          hn: qs('#hn').value,
          firstName: qs('#firstName').value,
          lastName: qs('#lastName').value,
          phone: qs('#phone').value,
          medicineId: med.id, medicineName: med.name,
          dailyDose: qs('#dailyDose').value,
          firstPickupDate: qs('#firstPickupDate').value,
          doctorAppointment: qs('#doctorAppointment').value
       };
       
       p.schedule = buildSchedule(p.firstPickupDate, p.doctorAppointment, p.dailyDose, med);
       
       showLoading(true);
       const res = await apiPost('savePrescription', {prescription: p});
       showLoading(false);
       
       if(res.success){
          currentPrescription = {...p, medicine:med, createdDate: getDateString(new Date())};
          renderResultCard();
          await fetchNextVN(); // ดึง VN ใหม่มาเตรียมไว้
          await loadPrescriptions(); // รีโหลดข้อมูลใบสั่งยาเข้าตาราง Production ทันที
          toast('บันทึกสำเร็จ','green');
       } else { toast(res.message,'red'); }
    }

    function renderResultCard(){
       const p = currentPrescription;
       qs('#patientPrescriptionCard').classList.remove('d-none');
       qs('#patientName').textContent = `${p.firstName} ${p.lastName}`;
       qs('#patientMeta').textContent = `VN: ${p.vn} | HN: ${p.hn}`;
       qs('#prescriptionTableBody').innerHTML = p.schedule.map(s=>`
          <tr><td>${s.round}</td><td>${thaiDate(s.date)}</td><td class="fw-bold text-primary">${s.bottles}</td><td>${thaiDate(s.expiry)}</td></tr>
       `).join('');
    }

    /* ====================== PRINTING (Fixed) ====================== */
    function printPrescription(p){
       if(!p) return;
       const med = medicines.find(m => m.id === p.medicineId) || { name: p.medicineName };
       
       const html = `
       <html><head><style>
          body { font-family: 'Sarabun', sans-serif; padding: 20px; }
          @page { size: A4; margin: 0; } 
          .container { max-width: 210mm; margin: 0 auto; }
          h1 { text-align: center; font-size: 24px; border-bottom: 2px solid #000; padding-bottom: 10px; }
          .info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
          table { width: 100%; border-collapse: collapse; }
          th { border-bottom: 2px solid #000; text-align: left; padding: 8px; }
          td { padding: 8px; border-bottom: 1px solid #eee; }
          .sig-box { border: 1px dashed #999; height: 50px; } 
       </style></head><body>
          <div class="container">
             <h1>ใบค้างรับยาผลิตเฉพาะราย (รับยาหลัง 14.00 น.)</h1>
             <div class="info">
                <div>VN: ${p.vn}<br>HN: ${p.hn}<br>ชื่อ: ${p.firstName} ${p.lastName}</div>
                <div>ยา: ${p.medicineName}<br>นัดหมอ: ${thaiDate(p.doctorAppointment)}<br>เบอร์: ${p.phone}</div>
             </div>
             <table>
                <thead><tr><th>ชื่อยา</th><th align="center">จำนวน(ขวด)</th><th>วันนัดรับยา</th><th align="center">ลายเซ็นเภสัชกร</th></tr></thead>
                <tbody>
                   ${(p.schedule||[]).map(s=>`
                   <tr>
                      <td>${p.medicineName}</td><td align="center"><strong>${s.bottles}</strong></td>
                      <td>${thaiDate(s.date)}</td><td><div class="sig-box"></div></td>
                   </tr>`).join('')}
                </tbody>
             </table>
          </div>
       </body></html>`;
       
       const iframe = document.createElement('iframe');
       iframe.style.display='none'; document.body.append(iframe);
       const doc = iframe.contentWindow.document;
       doc.write(html); doc.close();
       setTimeout(()=>{ iframe.contentWindow.print(); iframe.remove(); }, 500);
    }

    /* ====================== SEARCH & EDIT ====================== */
    async function searchForEdit(){
       const k = qs('#searchPrescription').value;
       const res = await apiGet('listPrescriptions', {q:k});
       const p = (res.prescriptions||[])[0];
       if(!p) return toast('ไม่พบข้อมูล','red');
       qs('#editForm').innerHTML = `<div class="alert alert-success">พบคุณ ${p.firstName} (VN:${p.vn})</div>`;
    }

    /* ====================== SEARCH PRINT TAB (Fixed) ====================== */
    async function searchForPrintTab(){
       const k = qs('#searchPrintInput').value;
       const res = await apiGet('listPrescriptions', {q:k});
       const p = (res.prescriptions||[])[0];
       if(!p) {
          qs('#printPreview').innerHTML = '<div class="text-danger">ไม่พบข้อมูล</div>';
          foundPrescriptionForPrint = null;
          return;
       }
       foundPrescriptionForPrint = p;
       qs('#printPreview').innerHTML = `
          <div class="border p-3 rounded d-flex justify-content-between align-items-center">
             <div><strong>${p.vn}</strong>: ${p.firstName} ${p.lastName} (${p.medicineName})</div>
             <button class="btn btn-info" onclick="printFoundPrescription()">พิมพ์</button>
          </div>
       `;
    }
    function printFoundPrescription(){
       if(foundPrescriptionForPrint) printPrescription(foundPrescriptionForPrint);
    }

    /* ====================== PRODUCTION TAB (New Feature) ====================== */
    async function searchProduction(){
       const dateStr = qs('#productionDate').value; // YYYY-MM-DD
       showLoading(true);
       await loadPrescriptions(); 
       
       const list = [];
       prescriptions.forEach(p => {
          (p.schedule||[]).forEach(s => {
             if(s.date === dateStr){
                const med = medicines.find(m=> m.id === p.medicineId || m.name === p.medicineName);
                const tabs = med ? (med.tabletsPerBottle || 0) : 0;
                list.push({
                   vn: p.vn, name: `${p.firstName} ${p.lastName}`,
                   medName: p.medicineName,
                   bottles: s.bottles,
                   totalTablets: s.bottles * tabs,
                   note: ''
                });
             }
          });
       });
       
       // เรียงลำดับตามชื่อยา แล้วค่อยตาม VN
       list.sort((a,b) => a.medName.localeCompare(b.medName) || a.vn.localeCompare(b.vn));

       const tbody = qs('#productionTable tbody');
       if(list.length === 0){
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ไม่พบรายการที่ต้องผลิตในวันนี้</td></tr>';
       } else {
          tbody.innerHTML = list.map((item, i) => `
             <tr>
                <td>${i+1}</td>
                <td>${item.medName} (VN:${item.vn} ${item.name})</td>
                <td>${item.bottles}</td>
                <td>${item.totalTablets}</td>
                <td>${item.note}</td>
             </tr>
          `).join('');
       }
       
       qs('#productionResult').classList.remove('d-none');
       showLoading(false);
    }

    function printProductionA5(){
       const dateStr = qs('#productionDate').value;
       const rows = qs('#productionTable tbody').innerHTML;
       
       const html = `
       <html><head><style>
          body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 10px; }
          @page { size: A5; margin: 0; }
          .a5-container { width: 148mm; min-height: 200mm; padding: 10mm; box-sizing: border-box; }
          h2, h3 { text-align: center; margin: 5px 0; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
          th, td { border: 1px solid black; padding: 4px; }
          .footer { margin-top: 20px; font-size: 12px; }
       </style></head><body>
          <div class="a5-container">
             <h3>ใบเบิกยาเตรียมผลิตผู้ป่วยเฉพาะราย</h3>
             <div><strong>เรียน</strong> หัวหน้างานผลิตยา</div>
             <p>ด้วยงานจ่ายยาผู้ป่วยนอกมีความประสงค์ที่จะขอเบิกยาเตรียมสำหรับผู้ป่วยเฉพาะราย ดังนี้ (ประจำวันที่ ${thaiDate(dateStr)})</p>
             <table>
                <thead><tr><th>ลำดับ</th><th>รายการยาเตรียม</th><th>ขวด</th><th>เม็ดที่ใช้</th><th>หมายเหตุ</th></tr></thead>
                <tbody>${rows}</tbody>
             </table>
             <div class="footer">
                <p>เวลารับยา .............................................</p>
                <p align="right" style="margin-top:30px;">ลงชื่อ ..................................................... เภสัชกร</p>
             </div>
          </div>
       </body></html>`;
       
       const iframe = document.createElement('iframe');
       iframe.style.display='none'; document.body.append(iframe);
       const doc = iframe.contentWindow.document;
       doc.write(html); doc.close();
       setTimeout(()=>{ iframe.contentWindow.print(); iframe.remove(); }, 500);
    }
    
    /* ====================== CALENDAR ====================== */
    function renderCalendar(){
       const m = currentCalendarDate.getMonth();
       const y = currentCalendarDate.getFullYear();
       qs('#currentMonth').textContent = `${['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'][m]} ${y+543}`;
       const firstDay = new Date(y, m, 1);
       const startDay = new Date(firstDay); startDay.setDate(1 - firstDay.getDay());
       
       const grid = qs('#calendarGrid'); grid.innerHTML = '';
       for(let w=0; w<6; w++){
          for(let d=0; d<7; d++){
             const curr = new Date(startDay); curr.setDate(startDay.getDate() + (w*7)+d);
             const dateStr = getDateString(curr); 
             
             let count = 0;
             prescriptions.forEach(p=>{
                (p.schedule||[]).forEach(s=>{ if(s.date === dateStr) count++; });
             });

             const isCurrMonth = curr.getMonth() === m;
             grid.innerHTML += `
               <div class="col" style="flex:0 0 14.28%">
                  <div class="border p-1 ${isCurrMonth?'bg-white':'bg-light text-muted'}" style="min-height:80px; font-size:12px;">
                     <div class="fw-bold">${curr.getDate()}</div>
                     ${count>0 ? `<span class="badge bg-primary">${count} คน</span>` : ''}
                  </div>
               </div>`;
          }
       }
    }
  </script>
</body>
</html>
